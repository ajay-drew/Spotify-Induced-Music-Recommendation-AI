SIMRAI – Spotify-Induced Music Recommendation AI
Short Design Snapshot (v0.3)
===============================================================================

1. PROJECT GOAL
-------------------------------------------------------------------------------
- SIMRAI turns a short, messy mood description (e.g. "rainy midnight drive
  with someone you miss") into a Spotify queue that feels emotionally aligned.
- It is:
  - Local-first by default (CLI + FastAPI + React web UI).
  - Metadata-driven (standard Spotify Web API fields).
  - Able to create playlists for the user via explicit Spotify OAuth.
  - Designed to later plug in an open-source LLM, but already useful without it.


2. CURRENT IMPLEMENTATION (HIGH-LEVEL)
-------------------------------------------------------------------------------
- Backend (Python, under src/simrai/):
  - CLI (`cli.py`, Typer + Rich):
    - `simrai queue "<mood>" [--length N] [--intense] [--soft]`
    - Shows a styled table with Track / Artist / Valence / Energy / URI.
    - Highlights when it is using metadata-only fallback mode.
  - FastAPI API (`api.py`):
    - `GET /health` – health check.
    - `POST /queue` – main JSON endpoint used by the web UI and any HTTP clients.
    - OAuth + playlist endpoints:
      - `GET /auth/login` – redirect to Spotify authorize page.
      - `GET /auth/callback` – exchange code, store access/refresh tokens locally.
      - `POST /api/create-playlist` – create a playlist in the connected account.
      - `POST /api/add-tracks` – add a list of track URIs to a playlist.
  - Spotify integration (`spotify.py`):
    - `DirectSpotifyClient`:
      - Uses Client Credentials flow.
      - `search_tracks(query, limit)` → standard Spotify metadata.
      - `get_audio_features(track_ids)` → audio features where allowed.
      - Handles token refresh and basic error handling.
    - `SpotifyService`:
      - Simple wrapper that chooses the backend (currently direct Web API).
  - Mood interpretation (`mood.py`):
    - Rule-based "Mood Alchemist v0":
      - Starts from neutral valence/energy (0.5, 0.5).
      - Adjusts based on keywords (sad, happy, chill, rage, etc.) and flags
        (`--intense`, `--soft`).
      - Produces:
        - `MoodVector(valence, energy)`.
        - `search_terms` list for Spotify search.
        - Preferences:
          - `prefer_popular`, `prefer_obscure`,
          - `prefer_recent`, `prefer_classics`.
  - Pipeline (`pipeline.py`):
    - `generate_queue(mood_text, length, intense, soft)`:
      1) Calls `interpret_mood(...)` to get a target mood vector + preferences.
      2) Uses `SpotifyService` to search for candidates (standard metadata).
      3) Tries to fetch audio features:
         - If available:
           - Scores tracks via distance in (valence, energy) space.
           - Selects best N, arranges in a gentle energy arc, returns queue.
         - If audio features are blocked (e.g. 403):
           - Falls back to **metadata-only scoring**:
             - Uses popularity, release year, and text heuristics (e.g. "remix",
               "acoustic", "piano") to synthesize valence/energy per track.
             - Uses preferences (popular/obscure, recent/classics) to rank.
             - Returns a queue with varied synthetic valence/energy and a
               summary explaining that audio features were unavailable.
  - Agents scaffold (`agents.py`):
    - Defines four conceptual agents (Mood Alchemist, Seed Curator,
      Psychoacoustic Analyst, Narrative Architect) using CrewAI.
    - `run_with_agents(...)` currently delegates to `generate_queue(...)`.
    - Ready for a future LangChain-compatible chat model (OSS LLM).
  - Config (`config.py`):
    - Loads `.env` with:
      - `SIMRAI_SPOTIFY_CLIENT_ID`, `SIMRAI_SPOTIFY_CLIENT_SECRET`.
      - Optional `SIMRAI_SPOTIFY_REDIRECT_URI`.
      - Optional MCP settings (not yet wired).
    - Provides a user config dir for storing OAuth tokens.

- Web UI (React + Tailwind + RPGUI, under web/):
  - Single-page app with Mario/pixel inspired styling.
  - Talks to FastAPI at `http://localhost:8000`:
    - `POST /queue?theme=mario` for queue generation.
    - `GET /auth/login` (opens in a new tab) for connecting Spotify.
    - `POST /api/create-playlist` + `/api/add-tracks` for exporting queues.
  - Features:
    - Mood form (textarea + length slider + intense/soft toggles).
    - "Start (Warp Pipe)" brew button with spinner.
    - Status pill: "MODE: METADATA-ONLY" vs "MODE: FULL FEATURES".
    - Recent mood history (localStorage).
    - Copy URIs button.
    - Create SIMRAI Playlist button opening the new playlist in Spotify.

- Dummy helper (`dummy/track_metadata_cli.py`):
  - Simple CLI to inspect Spotify metadata for a song:
    - Top matches table.
    - Raw track JSON.
    - Raw artist JSON (with genres).
    - Audio features (where endpoint is allowed).


3. KEY CONSTRAINTS AND GUARANTEES
-------------------------------------------------------------------------------
- Spotify usage:
  - Uses official Web API (search, metadata, artists, audio features where
    allowed, playlists via OAuth).
  - No playback control; SIMRAI never presses “play” for the user.
  - Playlist creation and adding tracks require explicit user OAuth consent.
- Data & privacy:
  - No automatic global mood history; any history is local and opt-in.
  - OAuth tokens are stored only on the host machine under the user config dir.
  - Web UI calls only the local FastAPI server; secrets never go to the browser.
- AI / LLM:
  - Current production path works **without** any LLM.
  - LLM integration is optional and should be:
    - OSS-first and free-to-use by default.
    - Pluggable so cloud providers (OpenAI/Anthropic) can be added behind a
      config flag later.


4. HOW THINGS FLOW (END TO END)
-------------------------------------------------------------------------------
- CLI path:
  1) User runs: `simrai queue "rainy midnight drive" --soft --length 15`.
  2) CLI calls `generate_queue(...)`.
  3) Pipeline:
     - Converts text → mood vector + preferences.
     - Calls Spotify search + (optional) audio features.
     - Builds an ordered queue with real or synthetic valence/energy.
  4) CLI prints Rich table + summary line and mode banner.

- Web path:
  1) User opens web app on `http://localhost:5658`.
  2) UI collects mood + options and `POST`s to FastAPI `/queue`.
  3) FastAPI wraps `generate_queue(...)` and returns JSON.
  4) UI renders queue table, mood vector, mode pill, and export options.
  5) If the user clicks "Connect Spotify":
     - Browser opens `/auth/login` → Spotify authorize → `/auth/callback`.
     - Tokens are stored locally on the server.
  6) User can then create a playlist from the current queue using
     `/api/create-playlist` + `/api/add-tracks`.


5. FUTURE WORK (SHORT, ACTIONABLE LIST)
-------------------------------------------------------------------------------
These are the main "next steps" without the long narrative:

- OSS LLM integration (local or cloud):
  - Run an open-source chat model (e.g., Llama 3 8B, Mistral 7B, Phi-3) via
    Ollama or similar.
  - Expose it as an HTTP endpoint (either on the same machine or a small VM).
  - Add a LangChain-compatible client in Python and wire it into
    `AgentConfig.llm` / `run_with_agents(...)`.
  - Optionally add a config flag to choose between:
    - Pure rule-based pipeline (current default).
    - Assisted pipeline (CrewAI + LLM + existing metadata logic).

- Better agent usage:
  - Have the Mood Alchemist agent:
    - Propose a richer mood vector + seed artists/genres.
  - Have the Seed Curator agent:
    - Suggest more diverse candidate directions against constraints.
  - Keep the actual Spotify calls and ranking in code (for reliability and TOS).

- Multi-user / remote hosting:
  - Run `simrai serve` on a public or tunneled host so friends can send moods.
  - Keep credentials and OAuth tokens on that host only.
  - Optionally add a simple authentication or API key for public demos.

- Polish & packaging:
  - Add a small installer or PyInstaller binary for easy installation.
  - Refine CLI and web copy (more expressive summary lines).
  - Improve docs with a short “Quickstart” for:
    - CLI-only users.
    - Web UI users.
    - Users connecting their own Spotify account.


6. HOW TO READ THIS FILE
-------------------------------------------------------------------------------
- This document is intentionally short:
  - It describes **what SIMRAI is today**, **how it works**, and **what to do
    next**, without a long story.
  - For detailed change history and design evolution, see `.cursorrules`.


